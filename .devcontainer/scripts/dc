#!/bin/bash

set -euo pipefail

# Load environment variables from root .env if it exists
if [ -f "/workspace/.env" ]; then
    set -a
    source /workspace/.env
    set +a
fi

# Setup Private Packagist authentication for Composer
dc-packagist-auth() {
    echo "ğŸ” Checking Private Packagist authentication..."
    echo ""
    
    COMPOSER_AUTH_FILE="$HOME/.composer/auth.json"
    if [ -f "$COMPOSER_AUTH_FILE" ] && grep -q "repo.packagist.com" "$COMPOSER_AUTH_FILE" 2>/dev/null; then
        echo "âœ… Private Packagist authentication is configured"
        return 0
    fi
    
    echo "âŒ Private Packagist authentication not configured"
    echo ""
    echo "To configure Private Packagist authentication:"
    echo ""
    echo "1. Visit: https://packagist.com/orgs/encodium"
    echo "2. Go to the 'Setup authentication' section"
    echo "3. Copy and paste the command provided by Packagist"
    echo ""
    echo "The command will look like:"
    echo "   composer config --global --auth http-basic.repo.packagist.com <username> <password>"
    echo ""
    echo "Credentials will persist in the home volume after configuration."
    return 1
}

# Setup npm authentication
dc-npmrc() {
    echo "ğŸ” Checking npm authentication..."
    echo ""
    
    NPMRC_FILE="$HOME/.npmrc"
    
    # Check if .npmrc already exists and has the required configuration
    if [ -f "$NPMRC_FILE" ] && grep -q "@encodium:registry" "$NPMRC_FILE" 2>/dev/null && grep -q "npm.pkg.github.com" "$NPMRC_FILE" 2>/dev/null; then
        echo "âœ… npm authentication is configured"
        return 0
    fi
    
    # If .npmrc exists but doesn't have the required config, check if it was imported from host
    if [ -f "$NPMRC_FILE" ]; then
        echo "â„¹ï¸  .npmrc file exists but missing GitHub Packages configuration for @encodium scope"
        echo ""
        echo "   The file will be updated to add the required configuration."
        echo ""
    else
        echo "âŒ npm authentication not configured"
        echo ""
    fi
    
    # Try to configure automatically if GitHub CLI is authenticated
    if ! gh auth status &>/dev/null; then
        echo "GitHub CLI authentication required to configure npm"
        echo ""
        echo "   Run: dc github-cli"
        echo "   Then run: dc npmrc"
        return 1
    fi
    
    local token
    if ! token=$(gh auth token 2>/dev/null); then
        echo "âŒ Failed to get GitHub token"
        echo "   Ensure GitHub CLI is authenticated: dc github-cli"
        return 1
    fi
    
    echo "Configuring npm authentication automatically..."
    
    # If .npmrc exists, append to it; otherwise create new file
    if [ -f "$NPMRC_FILE" ]; then
        # Check if the entries already exist to avoid duplicates
        if ! grep -q "@encodium:registry" "$NPMRC_FILE" 2>/dev/null; then
            echo "@encodium:registry=https://npm.pkg.github.com/" >> "$NPMRC_FILE"
        fi
        if ! grep -q "//npm.pkg.github.com/:_authToken" "$NPMRC_FILE" 2>/dev/null; then
            echo "//npm.pkg.github.com/:_authToken=$token" >> "$NPMRC_FILE"
        else
            # Update existing token
            sed -i "s|//npm.pkg.github.com/:_authToken=.*|//npm.pkg.github.com/:_authToken=$token|" "$NPMRC_FILE" 2>/dev/null || \
            sed "s|//npm.pkg.github.com/:_authToken=.*|//npm.pkg.github.com/:_authToken=$token|" "$NPMRC_FILE" > "${NPMRC_FILE}.tmp" && mv "${NPMRC_FILE}.tmp" "$NPMRC_FILE"
        fi
    else
        {
            echo "@encodium:registry=https://npm.pkg.github.com/"
            echo "//npm.pkg.github.com/:_authToken=$token"
        } > "$NPMRC_FILE"
    fi
    
    chmod 600 "$NPMRC_FILE"
    echo "âœ… npm authentication configured at $NPMRC_FILE"
    echo "   Using GitHub Packages registry for @encodium scope"
    echo "   Credentials will persist in the home volume"
    return 0
}

# Setup GitHub CLI authentication
dc-github-cli() {
    echo "ğŸ” Checking GitHub CLI authentication..."
    echo ""
    
    if gh auth status &>/dev/null; then
        echo "âœ… GitHub CLI is authenticated"
        return 0
    fi
    
    echo "âŒ GitHub CLI is not authenticated"
    echo ""
    echo "To authenticate GitHub CLI:"
    echo ""
    echo "   Run: gh auth login"
    echo ""
    echo "   Follow the prompts to authenticate. Credentials will persist in the home volume."
    return 1
}

# Clone repositories configured in REPOS_TO_CLONE environment variable
dc-clone-repos() {
    # Determine which repos to clone
    if [ $# -gt 0 ]; then
        REPOS_TO_CLONE="$*"
    fi
    
    echo "ğŸ“¦ Cloning repositories..."
    echo "   Configured repos: $REPOS_TO_CLONE"
    echo ""
    
    # Check GitHub CLI authentication
    if ! gh auth status &>/dev/null; then
        echo "âŒ ERROR: GitHub CLI authentication required to clone repositories"
        echo ""
        echo "   To configure GitHub CLI authentication:"
        echo "   1. Mount ~/.config/gh from host (if you have it configured on host), or"
        echo "   2. Run the following command:"
        echo "      gh auth login"
        echo ""
        return 1
    fi
    
    # Ensure workspace directory exists
    if [ ! -d "/workspace" ]; then
        mkdir -p /workspace
        echo "âœ… Created /workspace directory"
    fi
    
    # Clone repos
    IFS=',' read -ra REPOS <<< "$REPOS_TO_CLONE"
    SUCCESS_COUNT=0
    FAIL_COUNT=0
    SKIP_COUNT=0
    
    for repo in "${REPOS[@]}"; do
        repo=$(echo "$repo" | xargs) # trim whitespace
        if [ -z "$repo" ]; then
            continue
        fi
        
        repo_path="/workspace/$repo"
        
        if [ -d "$repo_path" ] && [ -d "$repo_path/.git" ]; then
            echo "âœ… Repository '$repo' already exists at $repo_path"
            SKIP_COUNT=$((SKIP_COUNT + 1))
        else
            echo "ğŸ“¦ Cloning repository: encodium/$repo..."
            if gh repo clone "encodium/$repo" "$repo_path" 2>&1; then
                echo "âœ… Successfully cloned encodium/$repo"
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                
                # Install dependencies if present, replace with justfile at some point...
                cd "$repo_path"
                
                # Run composer install if composer.json exists
                if [ -f "composer.json" ]; then
                    echo "   Installing Composer dependencies..."
                    if composer install --no-interaction 2>&1; then
                        echo "   âœ… Composer dependencies installed"
                    else
                        echo "   âš ï¸  Composer install had issues (may need authentication)"
                    fi
                fi
                
                # Run npm install if package.json exists
                if [ -f "package.json" ]; then
                    echo "   Installing npm dependencies..."
                    if npm install 2>&1; then
                        echo "   âœ… npm dependencies installed"
                    else
                        echo "   âš ï¸  npm install had issues (may need authentication)"
                    fi
                fi
            else
                echo "âŒ Failed to clone encodium/$repo"
                echo "   This may be due to:"
                echo "   - Repository doesn't exist or you don't have access"
                echo "   - GitHub CLI authentication issue (run 'gh auth login')"
                echo "   - Network connectivity issue"
                FAIL_COUNT=$((FAIL_COUNT + 1))
            fi
            echo ""
        fi
        
        # Check for .env file and copy .env.local if needed (for both newly cloned and existing repos)
        if [ -d "$repo_path" ] && [ -d "$repo_path/.git" ]; then
            cd "$repo_path"
            if [ ! -f ".env" ]; then
                if [ -f ".env.local" ]; then
                    echo "   ğŸ“‹ Copying .env.local to .env..."
                    cp ".env.local" ".env"
                    echo "   âœ… Created .env from .env.local"
                fi
            fi
        fi
    done
    
    # Summary
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“Š Clone Summary"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "   Successfully cloned: $SUCCESS_COUNT"
    echo "   Already existed: $SKIP_COUNT"
    echo "   Failed: $FAIL_COUNT"
    echo ""
    
    if [ $FAIL_COUNT -gt 0 ]; then
        echo "âš ï¸  Some repositories failed to clone. Check the errors above."
        echo "   You can retry cloning specific repos: dc clone-repos repo1,repo2"
        return 1
    elif [ $SUCCESS_COUNT -gt 0 ]; then
        echo "âœ… All repositories cloned successfully!"
        echo ""
        echo -e "   \033[1m\033[36mNext step:\033[0m Link common repo to other repositories if you haven't already:"
        echo -e "      \033[1m\033[32mdc link-common\033[0m"
    fi
}

# Link common repo to all workspace repositories using composer-link
dc-link-common() {
    local common_path="${COMMON_REPO_PATH}"
    
    echo "ğŸ”— Linking common repo to workspace repositories..."
    echo ""
    
    # Check if composer-link plugin is available
    if ! composer help link &>/dev/null; then
        echo "âŒ ERROR: composer-link plugin not found"
        echo ""
        echo "   The composer-link plugin should be installed in the Dockerfile."
        echo "   If it's missing, install it with:"
        echo "      composer global require sandersander/composer-link"
        echo ""
        return 1
    fi
    
    # Check if common repo exists
    if [ ! -d "$common_path" ]; then
        echo "âŒ ERROR: Common repo not found at $common_path"
        echo ""
        echo "   The common repo must be cloned first. Run:"
        echo "      dc clone-repos common"
        echo ""
        echo "   Or ensure the common repo exists at: $common_path"
        return 1
    fi
    
    # Check if common repo has composer.json
    if [ ! -f "$common_path/composer.json" ]; then
        echo "âŒ ERROR: composer.json not found in common repo at $common_path"
        echo ""
        echo "   The common repo must be a valid Composer package with a composer.json file."
        return 1
    fi
    
    # Get all repos in workspace (excluding common)
    local repos=()
    for dir in /workspace/*; do
        if [ -d "$dir" ] && [ -d "$dir/.git" ] && [ "$(basename "$dir")" != "common" ]; then
            repos+=("$dir")
        fi
    done
    
    if [ ${#repos[@]} -eq 0 ]; then
        echo "âš ï¸  No other repositories found in /workspace to link"
        echo ""
        echo "   Clone some repositories first:"
        echo "      dc clone-repos batch"
        echo ""
        return 0
    fi
    
    echo "Found ${#repos[@]} repository/repositories to link:"
    for repo in "${repos[@]}"; do
        echo "  - $(basename "$repo")"
    done
    echo ""
    
    # Link common to each repo
    local SUCCESS_COUNT=0
    local FAIL_COUNT=0
    local SKIP_COUNT=0
    
    for repo in "${repos[@]}"; do
        local repo_name=$(basename "$repo")
        echo "ğŸ“¦ Linking common to $repo_name..."
        
        # Check if repo has composer.json
        if [ ! -f "$repo/composer.json" ]; then
            echo "âš ï¸  Skipping $repo_name: no composer.json found"
            SKIP_COUNT=$((SKIP_COUNT + 1))
            echo ""
            continue
        fi
        
        # Check if already linked
        if [ -L "$repo/vendor/common" ] || [ -d "$repo/vendor/common" ]; then
            if [ -L "$repo/vendor/common" ] && [ "$(readlink -f "$repo/vendor/common")" = "$(readlink -f "$common_path")" ]; then
                echo "âœ… $repo_name already linked to common"
                SKIP_COUNT=$((SKIP_COUNT + 1))
                echo ""
                continue
            fi
        fi
        
        # Change to repo directory and link common
        cd "$repo"
        
        if composer link "$common_path" 2>&1; then
            echo "âœ… Successfully linked common to $repo_name"
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
        else
            echo "âŒ Failed to link common to $repo_name"
            echo "   This may be due to:"
            echo "   - Composer dependency conflicts"
            echo "   - Missing composer.json or invalid configuration"
            echo "   - Permission issues"
            FAIL_COUNT=$((FAIL_COUNT + 1))
        fi
        echo ""
    done
    
    # Summary
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“Š Link Summary"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "   Successfully linked: $SUCCESS_COUNT"
    echo "   Already linked: $SKIP_COUNT"
    echo "   Failed: $FAIL_COUNT"
    echo ""
    
    if [ $FAIL_COUNT -gt 0 ]; then
        echo "âš ï¸ Some repositories failed to link. Check the errors above."
        return 1
    elif [ $SUCCESS_COUNT -gt 0 ]; then
        echo "âœ… All repositories linked successfully!"
    fi
}

# Test environment (services and CLI authentication)
dc-test-env() {
    echo "Testing environment..."
    echo ""
    
    local issues=0
    
    # Test services
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "Services"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    echo -n "Redis: "
    if redis-cli -h "${REDIS_HOST}" -p 6379 ping &>/dev/null; then
        echo "âœ…"
    else
        echo "âŒ"
        issues=$((issues + 1))
    fi
    
    echo -n "MySQL: "
    if MYSQL_PWD="${MYSQL_PASSWORD}" mysql -h "${MYSQL_HOST}" -P "${MYSQL_PORT}" -u "${MYSQL_USER}" -e "SELECT 1;" &>/dev/null; then
        echo "âœ…"
    else
        echo "âŒ"
        issues=$((issues + 1))
    fi
    
    echo -n "LocalStack: "
    if curl -sf http://localstack:4566/_localstack/health | grep -q '"services":' 2>/dev/null; then
        echo "âœ…"
    else
        echo "âŒ"
        issues=$((issues + 1))
    fi
    
    echo ""
    
    # Test CLI authentication
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "CLI Authentication"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    echo -n "GitHub CLI: "
    if gh auth status &>/dev/null; then
        echo "âœ…"
    else
        echo "âŒ"
        issues=$((issues + 1))
    fi
    
    echo -n "Composer (Private Packagist): "
    COMPOSER_AUTH_FILE="$HOME/.composer/auth.json"
    if [ -f "$COMPOSER_AUTH_FILE" ] && grep -q "repo.packagist.com" "$COMPOSER_AUTH_FILE" 2>/dev/null; then
        echo "âœ…"
    else
        echo "âŒ"
        issues=$((issues + 1))
    fi
    
    echo -n "npm (GitHub Packages): "
    NPMRC_FILE="$HOME/.npmrc"
    if [ -f "$NPMRC_FILE" ] && grep -q "@encodium:registry" "$NPMRC_FILE" 2>/dev/null && grep -q "npm.pkg.github.com" "$NPMRC_FILE" 2>/dev/null; then
        echo "âœ…"
    else
        echo "âŒ"
        issues=$((issues + 1))
    fi
    
    echo ""
    
    if [ $issues -eq 0 ]; then
        echo "âœ… All checks passed!"
        return 0
    else
        echo "âš ï¸  Found $issues issue(s). Run 'dc help' for setup instructions."
        return 1
    fi
}

# Generate SFTP configuration files for all workspace repositories
# Usage: dc sftp-generate [playground-name]
#   playground-name: Optional override for PLAYGROUND_NAME environment variable
dc-sftp-generate() {
    # Check for optional playground name parameter
    local playground_name_override="${1:-}"
    local playground_name
    
    # Use override if provided, otherwise use environment variable
    if [ -n "$playground_name_override" ]; then
        playground_name="$playground_name_override"
    else
        playground_name="${PLAYGROUND_NAME:-}"
    fi
    
    echo "ğŸ“¤ Generating SFTP configuration files..."
    if [ -n "$playground_name_override" ]; then
        echo "   Using playground name: $playground_name (override)"
    fi
    echo ""
    
    # Required environment variables (PLAYGROUND_NAME can come from parameter or env)
    local required_vars=("SANDBOX_HOST" "SANDBOX_USERNAME" "SSH_AUTH_SOCK")
    local missing_vars=()
    
    # Check each required variable
    for var in "${required_vars[@]}"; do
        if [ -z "${!var:-}" ]; then
            missing_vars+=("$var")
        fi
    done
    
    # Check playground name separately (can come from parameter or env)
    if [ -z "$playground_name" ]; then
        missing_vars+=("PLAYGROUND_NAME")
    fi
    
    # If any variables are missing, report and exit
    if [ ${#missing_vars[@]} -gt 0 ]; then
        echo "âŒ ERROR: Missing required environment variables:"
        echo ""
        for var in "${missing_vars[@]}"; do
            echo "   - $var"
        done
        echo ""
        echo "Please add these variables to your .env file in the devcontainer and re-run the command."
        echo "Or provide PLAYGROUND_NAME as a parameter: dc sftp-generate <playground-name>"
        echo ""
        echo "Example:"
        echo "   SANDBOX_HOST=your-host.example.com"
        echo "   SANDBOX_USERNAME=your-username"
        echo "   PLAYGROUND_NAME=your-playground"
        echo ""
        echo "Or:"
        echo "   dc sftp-generate your-playground"
        return 1
    fi
    
    # Template file path - try multiple possible locations
    local template_file=""
    
    # Try workspace .vscode directory first (new location, available at runtime)
    if [ -f "/workspace/.vscode/sftp.template.json" ]; then
        template_file="/workspace/.vscode/sftp.template.json"
    # Try using script directory to find devcontainer root
    elif [ -n "${BASH_SOURCE[0]}" ]; then
        local script_dir
        script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        local devcontainer_dir
        devcontainer_dir="$(dirname "$script_dir")"
        if [ -f "$devcontainer_dir/.vscode/sftp.template.json" ]; then
            template_file="$devcontainer_dir/.vscode/sftp.template.json"
        fi
    fi
    
    # Check if template exists
    if [ -z "$template_file" ] || [ ! -f "$template_file" ]; then
        echo "âŒ ERROR: Template file not found"
        echo ""
        echo "   Expected location: /workspace/.vscode/sftp.template.json"
        if [ -n "${BASH_SOURCE[0]}" ]; then
            local script_dir
            script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
            local devcontainer_dir
            devcontainer_dir="$(dirname "$script_dir")"
            echo "     - $devcontainer_dir/.vscode/sftp.template.json"
        fi
        return 1
    fi
    
    # Check if workspace directory exists
    if [ ! -d "/workspace" ]; then
        echo "âŒ ERROR: /workspace directory not found"
        return 1
    fi
    
    # Find all git repositories in /workspace
    local repos=()
    for dir in /workspace/*; do
        if [ -d "$dir" ] && [ -d "$dir/.git" ]; then
            repos+=("$dir")
        fi
    done
    
    if [ ${#repos[@]} -eq 0 ]; then
        echo "âš ï¸  No git repositories found in /workspace"
        echo ""
        echo "   Clone some repositories first:"
        echo "      dc clone-repos batch,common"
        return 0
    fi
    
    echo "Found ${#repos[@]} repository/repositories:"
    for repo in "${repos[@]}"; do
        echo "  - $(basename "$repo")"
    done
    echo ""
    
    # Read template content
    local template_content
    template_content=$(cat "$template_file")
    
    # Create workspace .vscode directory if it doesn't exist
    local workspace_vscode_dir="/workspace/.vscode"
    
    # Generate SFTP config for each repo and collect into array
    local configs=()
    local success_count=0
    local fail_count=0
    
    for repo in "${repos[@]}"; do
        local repo_name=$(basename "$repo")
        
        echo "ğŸ“ Processing $repo_name..."
        
        # Replace template variables
        local config="$template_content"
        config=$(echo "$config" | sed "s|{{REPO_NAME}}|$repo_name|g")
        config=$(echo "$config" | sed "s|{{SANDBOX_HOST}}|$SANDBOX_HOST|g")
        config=$(echo "$config" | sed "s|{{SANDBOX_USERNAME}}|$SANDBOX_USERNAME|g")
        config=$(echo "$config" | sed "s|{{PLAYGROUND_NAME}}|$playground_name|g")
        
        # Add to configs array
        configs+=("$config")
        success_count=$((success_count + 1))
    done
    
    # Combine all configs into a JSON array
    local sftp_file="$workspace_vscode_dir/sftp.json"
    echo "ğŸ“ Generating combined SFTP config at $sftp_file..."
    
    # Build JSON array by joining configs with commas
    # Use a temporary file to build the JSON array properly
    local temp_file
    temp_file=$(mktemp)
    
    # Start with opening bracket
    echo "[" > "$temp_file"
    
    # Add each config with proper comma separation
    local first=true
    for config in "${configs[@]}"; do
        if [ "$first" = true ]; then
            first=false
        else
            echo "," >> "$temp_file"
        fi
        # Add config (each config should be a valid JSON object)
        echo "$config" >> "$temp_file"
    done
    
    # Close with closing bracket
    echo "]" >> "$temp_file"
    
    # Format JSON with jq and write to final file
    if jq . "$temp_file" > "$sftp_file" 2>/dev/null; then
        echo "âœ… Created $sftp_file with ${#configs[@]} configuration(s)"
        rm -f "$temp_file"
    else
        echo "âŒ Failed to create or format $sftp_file"
        echo "âš ï¸  Attempting to write unformatted JSON..."
        if mv "$temp_file" "$sftp_file"; then
            echo "âœ… Created $sftp_file (unformatted) with ${#configs[@]} configuration(s)"
        else
            echo "âŒ Failed to create $sftp_file"
            rm -f "$temp_file"
            fail_count=$((fail_count + 1))
            return 1
        fi
    fi
    echo ""
    
    # Summary
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“Š Generation Summary"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "   Successfully generated: $success_count"
    echo "   Failed: $fail_count"
    echo ""
    
    if [ $fail_count -gt 0 ]; then
        echo "âš ï¸  Some configurations failed to generate. Check the errors above."
        return 1
    elif [ $success_count -gt 0 ]; then
        echo "âœ… All SFTP configurations generated successfully in $sftp_file!"
    fi
}

# Display help/quick reference
dc-help() {
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“‹ Quick Reference"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Available Commands:"
    echo "  dc <command>            - Run our custom devcontainer commands"
    echo ""
    echo "Repository Management:"
    echo "  dc clone-repos [repos]  - Clone repositories (e.g., dc clone-repos batch,common)"
    echo "  dc link-common          - Link common repo to all workspace repositories"
    echo "  dc sftp-generate [playground] - Generate SFTP configuration files for all workspace repositories"
    echo "                                    Optional: override PLAYGROUND_NAME with parameter"
    echo ""
    echo "Authentication Setup:"
    echo "  dc packagist-auth       - Check and configure Private Packagist authentication"
    echo "  dc npmrc                - Check and configure npm authentication using GitHub token"
    echo "  dc github-cli           - Check GitHub CLI authentication status"
    echo ""
    echo "Environment Testing:"
    echo "  dc test-env             - Test connectivity to services and CLI authentication"
    echo ""
    echo "Available Aliases:"
    echo "  redis                   - Connect to Redis at ${REDIS_HOST}:6379"
    echo "  mysql                   - Connect to MySQL at ${MYSQL_HOST}:3306"
    echo "  awslocal                - AWS CLI with LocalStack endpoint (http://localstack:4566)"
    echo "  k                       - kubectl shortcut"
    echo ""
    echo "Service Connection Info:"
    echo "  Redis:      ${REDIS_HOST}:6379 (internal Docker network) / localhost:${REDIS_EXTERNAL_PORT} (external host)"
    echo "  MySQL:      ${MYSQL_HOST}:3306 (internal Docker network) / localhost:${MYSQL_EXTERNAL_PORT} (external host)"
    echo "  LocalStack: http://localstack:4566 (internal Docker network) / http://localhost:${LOCALSTACK_EXTERNAL_PORT} (external host)"
    echo ""
    echo "For more information, see: https://github.com/encodium/devcontainer"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
}

# Run all setup functions
dc-all() {
    echo "ğŸš€ Running all setup functions..."
    echo ""
    
    local failed=0
    
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "1. GitHub CLI"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    if ! dc-github-cli; then
        failed=$((failed + 1))
    fi
    echo ""
    
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "2. Private Packagist"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    if ! dc-packagist-auth; then
        failed=$((failed + 1))
    fi
    echo ""
    
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "3. npm"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    if ! dc-npmrc; then
        failed=$((failed + 1))
    fi
    echo ""
    
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    if [ $failed -eq 0 ]; then
        echo "âœ… All setup functions completed"
    else
        echo "âš ï¸  Some setup functions failed or were skipped"
    fi
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    return $failed
}

# Main function dispatcher
main() {
    local command="${1:-help}"
    
    case "$command" in
        packagist-auth)
            dc-packagist-auth
            ;;
        npmrc)
            dc-npmrc
            ;;
        github-cli)
            dc-github-cli
            ;;
        clone-repos)
            shift
            dc-clone-repos "$@"
            ;;
        link-common)
            dc-link-common
            ;;
        test-env)
            dc-test-env
            ;;
        sftp-generate)
            shift
            dc-sftp-generate "$@"
            ;;
        help|--help|-h)
            dc-help
            ;;
        all)
            dc-all
            ;;
        *)
            echo "Unknown command: $command"
            echo ""
            dc-help
            exit 1
            ;;
    esac
}

# If script is executed directly (not sourced), run main
if [ "${BASH_SOURCE[0]}" = "${0}" ]; then
    main "$@"
fi

