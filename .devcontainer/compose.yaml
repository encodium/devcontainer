services:
  shell:
    build:
      context: .
      dockerfile: Dockerfile
    command: sleep infinity
    env_file:
      - .env
    depends_on:
      - redis
      - mysql
      - localstack
    networks:
      - rp
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - home-data:/home/vscode

  redis:
    image: valkey/valkey:7.2-alpine
    ports:
      - "${REDIS_EXTERNAL_PORT:-6379}:${REDIS_PORT:-6379}"
    env_file:
      - .env
    networks:
      - rp
    healthcheck:
      test: ["CMD", "valkey-cli", "ping", "-h", "${REDIS_HOST:-redis}"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  mysql:
    image: mysql:8.0
    ports:
      - "${MYSQL_EXTERNAL_PORT:-3306}:${MYSQL_PORT:-3306}"
    env_file:
      - .env
    networks:
      - rp
    volumes:
      - mysql-data:/var/lib/mysql
      - ./database/init-test-db.sql:/docker-entrypoint-initdb.d/init-test-db.sql:ro
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "${MYSQL_HOST:-mysql}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  localstack:
    image: localstack/localstack:latest
    ports:
      - "${LOCALSTACK_EXTERNAL_PORT:-4566}:${LOCALSTACK_PORT:-4566}"
      - "${LOCALSTACK_EXTERNAL_PORT_RANGE_START:-4510}-${LOCALSTACK_EXTERNAL_PORT_RANGE_END:-4559}:${LOCALSTACK_PORT_RANGE_START:-4510}-${LOCALSTACK_PORT_RANGE_END:-4559}"
    environment:
      - SERVICES=s3,sqs,sns
      - DEBUG=1
      - DATA_DIR=/var/lib/localstack/data
      - DOCKER_HOST=unix:///var/run/docker.sock
    networks:
      - rp
    volumes:
      - localstack-data:/var/lib/localstack
      - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test: ["CMD", "curl", "-f", "http://${LOCALSTACK_HOST:-localstack}:${LOCALSTACK_PORT:-4566}/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

volumes:
  home-data:
  mysql-data:
  localstack-data:

networks:
  rp:

